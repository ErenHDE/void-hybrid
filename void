#!/usr/bin/env bash

detect_or_setup_void_packages() {
    if [ -d "$HOME/void-packages" ]; then
        VPDIR="$HOME/void-packages"
    elif [ -d "/usr/src/void-packages" ]; then
        VPDIR="/usr/src/void-packages"
    else
        echo "[!] void-packages not found â€” cloning..."
        git clone https://github.com/void-linux/void-packages.git "$HOME/void-packages" || { echo "Clone failed"; exit 1; }
        cd "$HOME/void-packages" || exit 1
        ./xbps-src binary-bootstrap || exit 1
        VPDIR="$HOME/void-packages"
        echo "[+] void-packages ready"
    fi
    echo "$VPDIR"
}

VPDIR=$(detect_or_setup_void_packages)


set -o pipefail
set -o nounset
#set -o errexit  # intentionally not set; script handles errors

# Colors
GREEN="\e[32m";
YELLOW="\e[33m";
RED="\e[31m";
BLUE="\e[34m";
RESET="\e[0m"

# Globals
ARCH=$(uname -m)
LOGFILE="/var/log/void-wrapper.log"
NONINTERACTIVE=false
FORCE_ACTION=false
VERBOSE=false

# If /var/log not writable, fallback to user's home
if [[ ! -w "$(dirname "$LOGFILE")" ]]; then
  LOGFILE="$HOME/.local/share/void-wrapper.log"
  mkdir -p "$(dirname "$LOGFILE")" 2>/dev/null || true
fi

log() { printf '%s\t%s\n' "$(date --iso-8601=seconds)" "$1" >> "$LOGFILE" 2>/dev/null || true; }

# --- Utility functions ---
ask_yes_no() {
  local prompt="$1" default_yes=${2:-false}
  if $NONINTERACTIVE; then
    $default_yes && return 0 || return 1
  fi
  local yn
  if $default_yes; then
    read -r -p "$prompt [Y/n]: " yn
    [[ -z "$yn" ]] && yn=Y
  else
    read -r -p "$prompt [y/N]: " yn
    [[ -z "$yn" ]] && yn=N
  fi
  case "$yn" in
    [Yy]*) return 0;;
    *) return 1;;
  esac
}

err() { echo -e "${RED}:: ERROR:${RESET} $*"; log "ERROR: $*"; }
info() { echo -e "${GREEN}:: $*${RESET}"; log "INFO: $*"; }
warn() { echo -e "${YELLOW}:: $*${RESET}"; log "WARN: $*"; }
note() { echo -e "${BLUE}:: $*${RESET}"; log "NOTE: $*"; }

# Determine real user even if run with sudo
get_real_user(){
  if [ "$EUID" -eq 0 ] && [ -n "${SUDO_USER:-}" ]; then
    printf '%s' "$SUDO_USER"
  else
    printf '%s' "${USER:-$(whoami)}"
  fi
}
get_real_home(){ getent passwd "$(get_real_user)" | cut -d: -f6; }

# Run with sudo if needed
need_sudo(){
  if [ "$EUID" -ne 0 ]; then
    if command -v sudo &>/dev/null; then
      sudo "$@"
    else
      err "This action requires root, but sudo is not available. Aborting."
      return 1
    fi
  else
    "$@"
  fi
}

# Run command as real user (for xbps-src operations)
run_as_user(){
    local ru
    ru=$(get_real_user)
    if [ "$EUID" -eq 0 ] && [ "$ru" != "root" ]; then
        if command -v sudo &>/dev/null; then
            sudo -H -u "$ru" "$@"
        else
            if $NONINTERACTIVE; then
                err "Non-interactive mode requires 'sudo' to run as real user."
                return 1
            fi
            info "Using 'su' to run as user '$ru'. Password may be required."
            su - "$ru" -c "$(printf '%q ' "$@")"
        fi
    else
        "$@"
    fi
}

# Try to find void-packages repo in common locations
find_void_packages(){
  if [[ -n "${VOID_PACKAGES_DIR:-}" ]]; then echo "$VOID_PACKAGES_DIR"; return 0; fi
  local user_home
  user_home=$(get_real_home)
  local candidates=("$user_home/void-packages" "$user_home/src/void-packages" "$user_home/src/void-packages" "/srv/void-packages" "/usr/local/src/void-packages" "/opt/void-packages" "/void-packages")
  for c in "${candidates[@]}"; do
    if [[ -d "$c" ]]; then
      printf '%s' "$c"; return 0
    fi
  done
  return 1
}

# Check and install missing base tools (git, xtools) - returns 0 on success
ensure_tools(){
  local missing=()
  command -v git &>/dev/null || missing+=(git)
  # xtools provides xnew and other helpers; if not present, add xtools
  if ! command -v xnew &>/dev/null; then
    missing+=(xtools)
  fi
  if [[ ${#missing[@]} -gt 0 ]]; then
    warn "Missing tools: ${missing[*]}. Will attempt to install via xbps."
    if ask_yes_no "Install missing tools (${missing[*]}) via xbps?" true; then
      if need_sudo xbps-install -Sy "${missing[@]}"; then
        info "Tools installed."
      else
        err "Failed to install required tools: ${missing[*]}"
        return 1
      fi
    else
      err "Required tools not installed. Aborting."
      return 1
    fi
  fi
  return 0
}

# Setup void-packages automatically (binary-bootstrap etc.)
setup_void_packages(){
  local vpdir
  vpdir="$1"
  if [[ -z "$vpdir" ]]; then
    local user_home
    user_home=$(get_real_home)
    vpdir="$user_home/void-packages"
  fi

  info "void-packages not found. Preparing to setup at: $vpdir"
  log "SETUP: start -> $vpdir"

  if ! ensure_tools; then return 1; fi

  if [[ -d "$vpdir" ]]; then
    warn "Target directory already exists: $vpdir"
    if ask_yes_no "Use existing directory and run a git pull there?" true; then
      pushd "$vpdir" >/dev/null 2>&1 || return 1
      run_as_user git pull --ff-only || true
      popd >/dev/null 2>&1
      return 0
    else
      return 1
    fi
  fi

  # Clone
  if ! $NONINTERACTIVE; then
    if ! ask_yes_no "Clone void-packages from upstream into $vpdir?" true; then
      warn "User declined clone. Aborting setup."
      return 1
    fi
  fi

  run_as_user mkdir -p "$(dirname "$vpdir")" || true
  if ! run_as_user git clone --depth 1 https://github.com/void-linux/void-packages.git "$vpdir"; then
    err "git clone failed. Please check network or git settings."
    return 1
  fi

  # Ensure etc/conf exists and set Xbps restricted if needed
  if [[ -f "$vpdir/etc/conf" ]]; then
    if ! run_as_user grep -q '^XBPS_ALLOW_RESTRICTED=' "$vpdir/etc/conf" 2>/dev/null; then
      run_as_user bash -c "echo 'XBPS_ALLOW_RESTRICTED=yes' >> '$vpdir/etc/conf'"
    fi
  else
    run_as_user bash -c "mkdir -p '$vpdir/etc' && echo 'XBPS_ALLOW_RESTRICTED=yes' > '$vpdir/etc/conf'"
  fi

  # Binary bootstrap
  note "Running xbps-src binary-bootstrap. This may take a while."
  pushd "$vpdir" >/dev/null || return 1
  if ! run_as_user ./xbps-src binary-bootstrap; then
    err "binary-bootstrap failed. Check logs in $vpdir/hostdir or run manually."
    popd >/dev/null
    return 1
  fi
  popd >/dev/null
  info "void-packages setup complete."
  return 0
}

# Build and install package from xbps-src
build_and_install_from_src(){
  local pkg="$1"
  local vp
  vp=$(find_void_packages || true)
  if [[ -z "$vp" ]]; then
    # Decide whether to auto-run setup or ask
    if $NONINTERACTIVE; then
      if ! setup_void_packages; then
        err "Automatic void-packages setup failed."
        return 1
      fi
    else
      if ask_yes_no "void-packages not found. Do you want to setup void-packages now?" true; then
        if ! setup_void_packages; then err "Setup failed"; return 1; fi
      else
        err "void-packages missing and user declined setup."
        return 1
      fi
    fi
    vp=$(find_void_packages || true)
    if [[ -z "$vp" ]]; then err "Cannot locate void-packages after setup."; return 1; fi
  fi

  # Check srcpkg exists, else offer to create template
  if [[ ! -d "$vp/srcpkgs/$pkg" ]]; then
    warn "Package template not found in void-packages: $pkg"
    if ask_yes_no "Create a new template using xnew for '$pkg' in void-packages? (requires xtools)" false; then
      if ! command -v xnew &>/dev/null; then
        warn "xtools (xnew) not found. Attempting to install xtools."
        if ! need_sudo xbps-install -y xtools; then
          err "Failed to install xtools. Cannot create template."
          return 1
        fi
      fi
      pushd "$vp" >/dev/null || return 1
      if ! run_as_user xnew "$pkg"; then
        err "xnew failed to create template for $pkg"
        popd >/dev/null
        return 1
      fi
      popd >/dev/null
    else
      err "Template missing and user declined creation."
      return 1
    fi
  fi

  pushd "$vp" >/dev/null || return 1
  note "Updating void-packages (git pull --ff-only)."
  run_as_user git pull --ff-only || warn "git pull failed; continuing with existing checkout."

  if [[ ! -d "masterdir" ]]; then
    note "masterdir missing; running binary-bootstrap"
    if ! run_as_user ./xbps-src binary-bootstrap; then
      err "binary-bootstrap failed."
      popd >/dev/null
      return 1
    fi
  fi

  note "Building package '$pkg' via xbps-src pkg"
  log "BUILD_START: $pkg"
  if ! run_as_user ./xbps-src pkg "$pkg"; then
    err "xbps-src build failed for $pkg. Check build logs in hostdir."; popd >/dev/null; return 1
  fi

  # Find produced binary
  local repo_base="$vp/hostdir/binpkgs"
  local repo_path
  if [[ -d "$repo_base/$ARCH" ]]; then repo_path="$repo_base/$ARCH"; else repo_path="$repo_base"; fi
  local found_path=""
  for sub in "" "/nonfree" "/multilib" "/multilib/nonfree"; do
    if compgen -G "$repo_path${sub}/${pkg}-*.xbps" >/dev/null; then
      found_path="$repo_path${sub}"
      break
    fi
  done
  if [[ -z "$found_path" ]]; then err "Built package not found under hostdir/binpkgs. Aborting."; popd >/dev/null; return 1; fi

  note "Installing package from repository: $found_path"
  if need_sudo xbps-install --repository="$found_path" -y "$pkg"; then
    info "Package $pkg installed successfully from source-built repo."
    popd >/dev/null
    return 0
  else
    err "Failed to install built package $pkg via xbps-install --repository."
    popd >/dev/null
    return 1
  fi
}

install_with_fallback(){
  local args=("$@")
  local pkgs=()
  for a in "${args[@]}"; do [[ "$a" != -* ]] && pkgs+=("$a"); done

  if [[ ${#pkgs[@]} -eq 0 ]]; then
    note "Running xbps-install ${args[*]}"
    need_sudo xbps-install "${args[@]}" || return $?
    return 0
  fi

  note "Attempting binary install: ${pkgs[*]}"

  # Binary install denemesi
  need_sudo xbps-install "${args[@]}"
  local exit_code=$?

  if [[ $exit_code -eq 0 ]]; then
    info "Binary install succeeded."
    return 0
  elif [[ $exit_code -eq 130 ]]; then
    # Ctrl+C ile iptal edildi
    warn "Installation cancelled by user (SIGINT). Skipping xbps-src fallback."
    return 130
  else
    warn "Binary install failed (exit code $exit_code). Trying xbps-src fallback."
    log "FALLBACK: ${pkgs[*]}"
  fi

  # Fallback build
  for p in "${pkgs[@]}"; do
    if ! build_and_install_from_src "$p"; then
      err "Fallback build/install failed for $p"
    fi
  done
}


# Search helper
search_pkg(){
  local q="$1"
  note "Searching repositories for: $q"
  xbps-query -Rs "$q" || true
}

# Update void-packages (vpsync)
vpsync(){
  local vp
  vp=$(find_void_packages || true)
  if [[ -z "$vp" ]]; then err "void-packages not found. Run with --src or run setup first."; return 1; fi
  pushd "$vp" >/dev/null || return 1
  run_as_user git pull --ff-only || { warn "git pull failed"; popd >/dev/null; return 1; }
  popd >/dev/null
  info "void-packages updated."
}

# Cleanup orphan and caches
cleanup(){
  note "Cleaning orphans and cache"
  if ask_yes_no "Remove orphans and clean cache now?" true; then
    need_sudo xbps-remove -Oo || warn "xbps-remove -Oo failed"
    need_sudo xbps-remove -OO || warn "xbps-remove -OO failed"
    info "Cleanup finished."
  else
    note "Cleanup aborted by user."
  fi
}

# Create template (explicit)
create_template(){
  local pkg="$1"
  local vp
  vp=$(find_void_packages || true)
  if [[ -z "$vp" ]]; then
    if ask_yes_no "void-packages not found. Create and setup now?" true; then
      setup_void_packages || return 1
      vp=$(find_void_packages || true) || return 1
    else
      err "void-packages required to create templates."
      return 1
    fi
  fi
  pushd "$vp" >/dev/null || return 1
  if ! command -v xnew &>/dev/null; then
    warn "xtools (xnew) not found. Installing xtools"
    need_sudo xbps-install -y xtools || { err "Failed to install xtools"; popd >/dev/null; return 1; }
  fi
  run_as_user xnew "$pkg" || { err "xnew failed"; popd >/dev/null; return 1; }
  popd >/dev/null
  info "Template created for $pkg in $vp/srcpkgs/$pkg"
}

# Show usage (English)
usage(){
  cat <<EOF
void - Advanced Void package helper
Usage: void [options] <package|command>
Commands:
  <name>                Search (xbps-query -Rs <name>) if single non-option arg
  -S [--install] ...    Try xbps-install; on failure automatically attempt xbps-src fallback
  -Su                   Run xbps-install -Su (system upgrade)
  -R <pkg>...           Remove packages (xbps-remove)
  --src <pkg>           Force build and install with xbps-src
  --new <pkg>           Create a new template (xnew)
  -V, --vpsync          Update local void-packages (git pull)
  -Oo                   Cleanup orphans and cache
  --setup               Setup void-packages (clone + binary-bootstrap)
  --yes, -y             Non-interactive / assume yes
  --verbose             More logs
  -h|--help             Show this help

Notes:
  - This wrapper will attempt to minimize manual steps. It can auto-clone void-packages,
    run binary-bootstrap, create templates with xnew and build packages if binary install fails.
  - Use --yes to run non-interactively. Use with caution.
EOF
}

# --- Argument parsing (simple) ---
if [[ $# -eq 0 ]]; then usage; exit 0; fi

# Handle global flags
ARGS=()
while [[ $# -gt 0 ]]; do
  case "$1" in
    --yes|-y) NONINTERACTIVE=true; shift ;;
    --verbose) VERBOSE=true; shift ;;
    --setup) shift; setup_void_packages || exit 1; exit 0 ;;
    --help|-h) usage; exit 0 ;;
    --) shift; while [[ $# -gt 0 ]]; do ARGS+=("$1"); shift; done; break ;;
    *) ARGS+=("$1"); shift ;;
  esac
done

# If verbose, echo logfile location
$VERBOSE && info "Log file: $LOGFILE"

# If single arg and not option -> search
if [[ ${#ARGS[@]} -eq 1 && "${ARGS[0]:0:1}" != "-" ]]; then
  search_pkg "${ARGS[0]}"
  exit 0
fi

# Main command dispatch
case "${ARGS[0]:-}" in
  -S|--install)
    shift
    install_with_fallback "${ARGS[@]:1}"
    ;;
  -Su)
    note "Performing system upgrade"
    need_sudo xbps-install -Su
    ;;
  -R)
    if [[ ${#ARGS[@]} -lt 2 ]]; then err "No package specified for removal"; usage; exit 1; fi
    need_sudo xbps-remove "${ARGS[@]:1}"
    ;;
  -V|--vpsync)
    vpsync
    ;;
  --src)
    if [[ ${#ARGS[@]} -lt 2 ]]; then
      err "No package specified for --src"
      usage
      exit 1
    fi
    build_and_install_from_src "${ARGS[1]}"
    exit $?
    ;;
  --new)
    if [[ ${#ARGS[@]} -lt 2 ]]; then err "No package specified for --new"; usage; exit 1; fi
    create_template "${ARGS[1]}"
    ;;
  -Oo)
    cleanup
    ;;
  *)
    # Default: forward to xbps-install with fallback
    install_with_fallback "${ARGS[@]}"
    ;;
esac

exit 0
